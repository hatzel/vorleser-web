<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>Vorleser</title>
  <script type="text/javascript" src="elm.js"></script>
  <link href='vendor/roboto.css' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="vendor/material.min.css" />
</head>

<body>
  <div id="main"></div>
</body>

<script type="text/javascript">
  var node = document.getElementById('main');
  var app = Elm.Main.embed(node);
  var audio = new Audio();
  setInterval(() => {
    sendProgress()
  }, 500);

  app.ports.command.subscribe(function(command) {
    if (command.command == "SetFile") {
      audio.pause();
      delete audio;
      audio = new Audio(command.arg.file);
      audio.currentTime = command.arg.position
      audio.addEventListener("canplay", () => {
        app.ports.ready.send(audio.position || 0)
      });
    } else if (command.command === "Play") {
      audio.play();
    } else if (command.command === "Pause") {
      audio.pause();
    } else if (command.command === "Unpause") {
      audio.play();
    } else if (command.command === "Toggle") {
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause()
      }
    } else if (command.command === "SkipTo") {
      audio.currentTime = command.arg.position;
    }
    sendPlaying();
  })

  function sendProgress() {
    console.log(audio.readyState)
    if (audio.readyState == 4) {
      console.log("sending progress: ")
      app.ports.progress.send(audio.currentTime)
    }
  }

  function sendPlaying() {
    app.ports.playing.send(!audio.paused)
  }
</script>

</html>
